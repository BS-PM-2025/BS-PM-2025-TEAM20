pipeline {
    agent any

    environment {
        // מוסיף את ~/.local/bin ל-PATH כדי ש-pip --user יעבוד
        PATH = "${HOME}/.local/bin:${env.PATH}"

        // מציין את קובץ ההגדרות של Django
        DJANGO_SETTINGS_MODULE = "djangoProject11.settings"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                    # עדכון pip למשתמש
                    pip3 install --user --upgrade pip

                    # התקנת התלויות
                    pip3 install --user -r requirements.txt
                '''
            }
        }

        stage('Check DB Engine') {
            steps {
                sh '''
                    echo "📦 בדיקת תקינות המנוע..."
                    grep ENGINE djangoProject11/settings.py || echo "⚠️ שים לב: ENGINE לא מוגדר בקובץ settings.py"
                '''
            }
        }

        stage('Run Migrations') {
            steps {
                sh '''
                    echo "🛠️ מריץ מיגרציות..."
                    python3 manage.py migrate
                '''
            }
        }

        stage('Run Tests') {
            steps {
                sh '''
                    echo "🧪 מריץ בדיקות..."
                    python3 manage.py test
                '''
            }
        }
    }

    post {
        success {
            echo '🎉 כל השלבים עברו בהצלחה!'
        }
        failure {
            echo '❌ יש שגיאה – בדוק את לוג Jenkins.'
        }
    }
}
