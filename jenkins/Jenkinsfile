pipeline {
    agent any

    environment {
        PYTHONUNBUFFERED = '1'
        DJANGO_SETTINGS_MODULE = 'djangoProject11.settings'
        PYTHONPATH = "${env.WORKSPACE}"
        CI = 'true'
    }

    stages {
        stage('Install Dependencies') {
            steps {
                echo 'ğŸ“¦ Installing dependencies...'
                sh 'pip install -r requirements.txt || pip install Django pytest pytest-django'
            }
        }

        stage('Prepare Database') {
            steps {
                echo 'ğŸ—„ï¸ Preparing database...'
                sh '''
                    echo "------------------------------"
                    echo "ğŸ—„ï¸ Running makemigrations"
                    echo "------------------------------"
                    python3 manage.py makemigrations

                    echo "------------------------------"
                    echo "ğŸ—„ï¸ Running migrate"
                    echo "------------------------------"
                    python3 manage.py migrate
                '''
            }
        }

        stage('Run Unit + Integration Tests') {
            steps {
                echo 'ğŸ§ª Running Django tests with coverage...'
                sh '''
                    echo "------------------------------"
                    echo "ğŸ§ª Running pytest tests"
                    echo "------------------------------"
                    python3 -m pytest accounts/tests.py --ds=djangoProject11.settings --junitxml=test-results.xml || true

                    echo "------------------------------"
                    echo "ğŸ“‹ Test Summary (last 20 lines)"
                    echo "------------------------------"
                    tail -n 20 test-results.xml || true
                '''
            }
        }

        stage('Calculate Defect Density') {
            steps {
                echo 'ğŸ“Š Calculating Defect Density...'
                sh '''
                    echo "------------------------------"
                    echo "ğŸ“Š Calculating Defect Density"
                    echo "------------------------------"
                    FAILURES=$(grep -o 'failures="\\?[0-9]\\+"' test-results.xml | grep -o '[0-9]')
                    LOC=$(find accounts -name "*.py" ! -path "*tests*" ! -path "*migrations*" ! -path "*venv*" | xargs wc -l | tail -n1 | awk '{print $1}')
                    if [ "$LOC" -gt 0 ]; then
                        DEFECT_DENSITY=$(echo "scale=2; $FAILURES / $LOC * 1000" | bc)
                    else
                        DEFECT_DENSITY=0
                    fi
                    echo "ğŸ“ˆ Defect Density: $DEFECT_DENSITY defects per 1000 LOC"
                '''
            }
        }

        stage('Code Coverage') {
            steps {
                echo 'ğŸ“Š Measuring code coverage with pytest-cov...'
                sh '''
                    pip install pytest-cov || true
                    echo "------------------------------"
                    echo "ğŸ“Š Running pytest with coverage"
                    echo "------------------------------"
                    python3 -m pytest accounts/tests.py --ds=djangoProject11.settings --cov=accounts --cov-report=term-missing --cov-report=xml || true
                '''
            }
        }

        stage('Static Code Check: pylint') {
            steps {
                echo 'ğŸ“ Running pylint...'
                sh '''
                    pip install pylint || true
                    export PATH=$PATH:$HOME/.local/bin
                    echo "------------------------------"
                    echo "ğŸ“‹ pylint Report"
                    echo "------------------------------"
                    pylint accounts --exit-zero | tee pylint_report.txt
                    echo "------------------------------"
                    echo "ğŸ“‹ pylint Summary (last 10 lines)"
                    echo "------------------------------"
                    tail -n 10 pylint_report.txt
                    echo "------------------------------"
                '''
            }
        }
    }

    post {
        always {
            echo 'ğŸ“Š Archiving test results...'
            junit 'test-results.xml'
        }
    }
}
