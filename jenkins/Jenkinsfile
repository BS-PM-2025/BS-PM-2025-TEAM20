pipeline {
    agent any

    environment {
        // ×”×•×¡×¤×ª ×”× ×ª×™×‘ ×©×œ pip --user ×œÖ¾PATH
        PATH = "${HOME}/.local/bin:${env.PATH}"

        // ××©×ª× ×” Django
        DJANGO_SETTINGS_MODULE = "djangoProject11.settings"

        // ×¤×ª×¨×•×Ÿ ×œ×‘×¢×™×” ×©×œ ModuleNotFoundError ×¢×‘×•×¨ mssql
        PYTHONUSERBASE = "${HOME}/.local"
        PYTHONPATH = "${HOME}/.local/lib/python3.10/site-packages:${env.PYTHONPATH}"
        // ×©×™××™ ×œ×‘: ×©× ×” ××ª python3.10 ×× ××ª ××©×ª××©×ª ×‘×’×¨×¡×” ××—×¨×ª
    }
stage('Install Dependencies') {
    steps {
        sh '''
            echo "â¬‡ï¸ Installing Microsoft ODBC Driver..."
            curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
            curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
            sudo apt-get update
            sudo ACCEPT_EULA=Y apt-get install -y msodbcsql17
            echo "â¬‡ï¸ Installing Python packages..."
            pip3 install --user --upgrade pip
            pip3 install --user -r requirements.txt
        '''
    }
}
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                    echo "â¬‡ï¸ ××ª×§×™×Ÿ ×—×‘×™×œ×•×ª..."
                    pip3 install --user --upgrade pip
                    pip3 install --user -r requirements.txt
                '''
            }
        }

        stage('Check DB Engine') {
            steps {
                sh '''
                    echo "ğŸ“¦ ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×”×× ×•×¢..."
                    grep ENGINE djangoProject11/settings.py || echo "âš ï¸ ×©×™× ×œ×‘: ENGINE ×œ× ××•×’×“×¨ ×‘×§×•×‘×¥ settings.py"
                '''
            }
        }

        stage('Run Migrations') {
            steps {
                sh '''
                    echo "ğŸ› ï¸ ××¨×™×¥ ××™×’×¨×¦×™×•×ª..."
                    PYTHONPATH=$PYTHONPATH python3 manage.py migrate
                '''
            }
        }

        stage('Run Tests') {
            steps {
                sh '''
                    echo "ğŸ§ª ××¨×™×¥ ×‘×“×™×§×•×ª..."
                    PYTHONPATH=$PYTHONPATH python3 manage.py test
                '''
            }
        }
    }

    post {
        success {
            echo 'ğŸ‰ ×›×œ ×”×©×œ×‘×™× ×¢×‘×¨×• ×‘×”×¦×œ×—×”!'
        }
        failure {
            echo 'âŒ ×™×© ×©×’×™××” â€“ ×‘×“×•×§ ××ª ×œ×•×’ Jenkins.'
        }
    }
}
