pipeline {
    agent any

    environment {
        PATH = "${HOME}/.local/bin:${env.PATH}"
        DJANGO_SETTINGS_MODULE = "djangoProject11.settings"
        PYTHONUSERBASE = "${HOME}/.local"
        PYTHONPATH = "${HOME}/.local/lib/python3.10/site-packages:${env.PYTHONPATH}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup Python') {
            steps {
                sh '''
                    echo "‚¨áÔ∏è Installing Python packages..."
                    python3 -m pip install --user --upgrade pip
                    python3 -m pip install --user -r requirements.txt
                '''
            }
        }

        stage('Check DB Engine') {
            steps {
                sh '''
                    echo "üì¶ Checking database configuration..."
                    grep -A 10 "DATABASES" djangoProject11/settings.py || echo "‚ö†Ô∏è Database config not found"
                '''
            }
        }

        stage('Run Migrations') {
            steps {
                sh '''
                    echo "üõ†Ô∏è Running migrations..."
                    python3 manage.py migrate --no-input
                '''
            }
        }

        stage('Run Tests') {
            steps {
                sh '''
                    echo "üß™ Running tests..."
                    python3 manage.py test --no-input
                '''
            }
        }
    }

    post {
        success {
            echo 'üéâ Pipeline completed successfully!'
        }
        failure {
            echo '‚ùå Pipeline failed - check logs!'
            archiveArtifacts artifacts: '**/migrations/*.py', allowEmptyArchive: true
        }
    }
}