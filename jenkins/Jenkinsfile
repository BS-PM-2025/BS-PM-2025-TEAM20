pipeline {
    agent any

    environment {
        // ××‘×˜×™×— ×©×”×¡×¨×’×œ ~/.local/bin ×™×ª×•×•×¡×£ ×œ-PATH ×›×“×™ ×©×”-pip --user ×™×”×™×” ×–××™×Ÿ
        PATH = "${HOME}/.local/bin:${env.PATH}"
    }

    stages {
        stage('Checkout') {
            steps {
                // ×©×•×œ×£ ××ª ×”×§×•×“ ××”Ö¾SCM ×©×”×•×’×“×¨ ×‘â€‘Job
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                    # ××ª×§×™×Ÿ pip ×•Ö¾virtualenv (×× × ×“×¨×©) ×œ××©×ª××© ×•×œ× ×œ×¦×•×¨×š ×”×¨×¦×ª root
                    pip3 install --user --upgrade pip

                    # ××ª×§×™×Ÿ ××ª ×›×œ ×”×ª×œ×•×™×•×ª ××§×•×‘×¥ requirements.txt ×œ×ª×•×š ~/.local
                    pip3 install --user -r requirements.txt
                '''
            }
        }

        stage('Run Migrations') {
            steps {
                // ××¨×™×¥ ××™×’×¨×¦×™×•×ª ×‘×¢×–×¨×ª python3 ××ª×•×š ×”××¢×¨×›×ª
                sh 'python3 manage.py migrate'
            }
        }

        stage('Run Tests') {
            steps {
                // ××¨×™×¥ ××ª ×›×œ ×”×‘×“×™×§×•×ª
                sh 'python3 manage.py test'
            }
        }
    }

    post {
        success {
            echo 'ğŸ‰ ×›×œ ×”×©×œ×‘×™× ×¢×‘×¨×• ×‘×”×¦×œ×—×”!'
        }
        failure {
            echo 'âŒ ×™×© ×©×’×™××” â€“ ×‘×“×•×§ ××ª ×œ×•×’ Jenkins.'
        }
    }
}
