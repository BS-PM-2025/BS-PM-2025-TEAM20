pipeline {
    agent any

    environment {
        PATH = "${HOME}/.local/bin:${env.PATH}"
        DJANGO_SETTINGS_MODULE = "djangoProject11.settings"
        PYTHONUSERBASE = "${HOME}/.local"
        PYTHONPATH = "${HOME}/.local/lib/python3.10/site-packages:${env.PYTHONPATH}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                    echo "â¬‡ï¸ Installing Microsoft ODBC Driver..."
                    # ×”×•×¨×“×” ×•×”×ª×§× ×” ×œ×œ× ×©×™××•×© ×‘-sudo
                    curl https://packages.microsoft.com/keys/microsoft.asc > microsoft.asc
                    gpg --dearmor < microsoft.asc > microsoft.gpg
                    mv microsoft.gpg /etc/apt/trusted.gpg.d/

                    curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list > mssql-release.list
                    mv mssql-release.list /etc/apt/sources.list.d/

                    apt-get update -y
                    ACCEPT_EULA=Y apt-get install -y msodbcsql17 unixodbc-dev

                    echo "â¬‡ï¸ Installing Python packages..."
                    pip3 install --user --upgrade pip
                    pip3 install --user -r requirements.txt
                '''
            }
        }

        stage('Check DB Engine') {
            steps {
                sh '''
                    echo "ğŸ“¦ Checking database engine..."
                    grep "ENGINE" djangoProject11/settings.py || echo "âš ï¸ ENGINE not found in settings.py"
                '''
            }
        }

        stage('Run Migrations') {
            steps {
                sh '''
                    echo "ğŸ› ï¸ Running migrations..."
                    python3 manage.py migrate
                '''
            }
        }

        stage('Run Tests') {
            steps {
                sh '''
                    echo "ğŸ§ª Running tests..."
                    python3 manage.py test
                '''
            }
        }
    }

    post {
        success {
            echo 'ğŸ‰ Pipeline completed successfully!'
        }
        failure {
            echo 'âŒ Pipeline failed - check logs!'
        }
    }
}